# RDE声学模拟代码库 (acoustic_RDE)

## 项目简介

本代码库提供了旋转爆轰发动机（Rotating Detonation Engine, RDE）内声学现象模拟的基础代码。代码实现了基于有限差分和有限体积方法的声学波动方程求解，用于研究RDE中旋转爆轰波产生的声场特性及其传播规律。

## 主要功能

- **声学波动方程求解**：实现线性声学方程的数值求解
- **旋转爆轰波源项**：模拟旋转爆轰波作为声源，考虑波前传播和衰减
- **多种网格类型**：支持结构化网格和非结构化O网格
- **高性能串行优化**：非结构化O网格版本通过Numba + 向量化 + 预分配/重用数组，在单核上获得接近并行的性能
- **可视化输出**：生成VTK格式文件，便于ParaView等工具可视化分析
- **进度条显示**：实时显示计算进度（百分比进度条）
- **日志记录**：自动记录时间步、残差、压力统计等关键参数到文本文件

## 代码文件说明

### 核心模拟代码

#### `plane_2D.py` - 结构化网格版本
- **功能**：使用结构化矩形网格进行2D声学模拟
- **数值方法**：有限差分法（FDM）
- **网格类型**：结构化网格 + 掩码（mask）筛选环形区域
- **特点**：
  - 实现RK4时间积分方法（四阶精度）
  - 硬壁边界条件（法向速度为零，符合物理）
  - 数值滤波机制（抑制高频振荡）
  - CFL稳定性检查（自动验证时间步长）
  - **物理正确性**：
    - 源项单位正确（Pa/s），使用特征时间转换
    - 运动黏度明确为数值耗散项（人工耗散）
    - 边界处使用单侧差分，避免周期性边界错误
  - **输出完整**：包含压力场、速度场、速度大小、有效区域掩码
- **适用场景**：快速原型验证、参数研究

#### `plane_2D_Ogrid.py` - 非结构化O网格版本（优化版本）
- **功能**：使用非结构化环形网格进行2D声学模拟
- **数值方法**：有限体积法（FVM）
- **网格类型**：非结构化O网格（环形四边形单元）
- **特点**：
  - 网格质量更高，边界处理更精确
  - **高性能优化**：通过预计算和向量化实现，性能提升10-20倍
    - 预计算几何量（边向量、法向量、长度等）
    - 预计算边-邻居映射（避免运行时查找）
    - 向量化操作（numpy数组操作）
    - 直接计算拉普拉斯（避免双重计算）
  - 与`plane_2D.py`物理模型一致
  - **参数配置**：通过`control.py`模块统一管理所有参数
  - **进度显示**：实时百分比进度条，显示已用时间和预计剩余时间
  - **日志记录**：自动记录计算过程的关键参数（时间步、残差、压力统计等）
  - **基于时间的输出**：VTK文件和日志输出都基于时间间隔，更加直观
- **适用场景**：高精度模拟、大规模计算
- **性能**：对于4000个网格，每个时间步约0.1-0.3秒（优化前为2-3秒）
- **使用方法**：
  ```bash
  python plane_2D_Ogrid.py              # 直接运行模拟（已优化，无需指定核数）
  python ogrid_preview_gui.py           # 先弹窗预览初始化压力分布，确认后再运行模拟
  ```
  **注意**：命令行参数 `-n` 和 `--single` 已弃用，性能优化通过预计算和向量化实现，不再使用multiprocessing

#### `ogrid_preview_gui.py` - O网格模拟预览与启动
- **功能**：在正式计算前弹窗展示初始化压力分布（推进 1 个时间步后的压力场），便于检查参数与网格设置是否正确。
- **界面**：左侧为压力分布图（单元中心散点，颜色表示压力 [Pa]），右侧为两个按钮：
  - **Continue（继续计算）**：关闭窗口并启动 `plane_2D_Ogrid` 主模拟；
  - **Break（退出程序）**：关闭窗口并退出，不进行后续计算。
- **使用场景**：建议在修改 `control.py` 后首次运行、或需要确认爆轰波宽度/源项范围时使用。

#### `control.py` - 参数控制模块
- **功能**：统一管理所有模拟参数
- **参数类型**：
  - **物理参数**：密度、声速、运动黏度
  - **几何参数**：内外半径、网格间距
  - **时间参数**：时间步长、结束时间
  - **声源参数**：爆轰波压强、传播速度、衰减尺度等
  - **数值计算参数**：滤波强度、CFL数、边界容差等
  - **输出参数**：输出目录、输出频率等
  - **并行计算参数**：默认并行设置
- **使用方法**：
  ```python
  from control import control
  params = control()  # 获取参数字典
  # 修改参数后传递给主程序
  ```
- **自定义参数**：直接编辑`control.py`中的`control()`函数，修改相应参数值

### 网格生成

#### `mesh.py` - 非结构化O网格生成
- **功能**：生成环形非结构化网格（O-cut annulus）
- **输出格式**：VTK格式，可用于ParaView可视化
- **特点**：
  - **网格闭合性**：确保theta数组闭合（使用linspace），避免角度方向间隙
  - **边界完整性**：确保r数组不超出物理边界R
  - **网格质量检查**：
    - 单元面积验证（确保为正）
    - 周期性边界连接验证
    - 网格统计信息输出（面积、节点数、单元数等）
  - **参数一致性**：与`plane_2D.py`的几何参数完全一致（R, r_core, dr）
  - **详细输出**：生成网格时输出详细的统计和质量信息
- **输出文件**：`mesh/o_cut_annulus.vtk`

### 可视化脚本

#### `signal_acoustic_1D.py` - 1D信号可视化
- **功能**：展示爆轰波在圆周上的传播动画
- **模型**：陡升+指数衰减的爆轰信号
- **输出**：matplotlib动画
- **参数一致性**：半径参数R=0.01m，与主模拟代码一致

#### `signal_acoustic_2D.py` - 2D压力云图可视化
- **功能**：展示倾斜爆轰波在管道中的压力分布动画
- **模型**：考虑前倾角度的爆轰波传播
- **输出**：matplotlib动画
- **参数一致性**：
  - 半径参数R=0.01m，与主模拟代码一致
  - 前倾角度10度（注释已修正）
  - 压力单位明确为Pa（不是atm）

## 物理模型

### 控制方程

线性声学波动方程：

```
压力方程:  dp/dt = -ρ₀c₀²·div(u) + S
速度方程:  du/dt = -grad(p)/ρ₀ + ν·laplacian(u)
```

其中：
- `p`: 声压 [Pa]
- `u, v`: 速度分量 [m/s]
- `ρ₀`: 空气密度 [kg/m³]
- `c₀`: 声速 [m/s]
- `ν`: 运动黏度 [m²/s]（主要用于数值稳定性）
- `S`: 源项 [Pa/s]

### 源项模型

旋转爆轰波源项：
- **位置**：环形区域（内半径到外半径）
- **传播**：以角速度ω旋转（ω = v_rde / R）
- **形状**：高斯衰减模型
- **方向**：只在波前方向（dtheta ≥ 0）
- **单位**：源项S的单位为[Pa/s]（压力变化率）
- **特征时间**：使用tau = 2πR/v_rde（爆轰波传播一圈的时间）进行单位转换
- **物理正确性**：确保源项单位与声学方程一致

### 边界条件

- **硬壁边界条件**：壁面处法向速度为零（u·n = 0）
- **内壁和外壁**：分别处理内边界和外边界
- **边界识别**：使用容差判断边界点（tolerance = 1.5 * dr）
- **法向量计算**：正确计算内壁（指向圆心）和外壁（指向外部）的法向量
- **差分格式**：边界处使用单侧差分（前向/后向），避免周期性边界错误
- **压力边界**：保持压力连续，让数值方法自然处理压力梯度

## 快速开始

### 1. 安装依赖

```bash
# 创建虚拟环境（推荐）
python -m venv .venv
source .venv/bin/activate  # macOS/Linux
# 或 .venv\Scripts\activate  # Windows

# 安装依赖
pip install -r requirements.txt
```

详细安装说明请参考 [README_INSTALL.md](README_INSTALL.md)

### 2. 运行模拟

```bash
# 结构化网格版本
python plane_2D.py

# 非结构化O网格版本（推荐，网格质量更高）
python plane_2D_Ogrid.py

# 生成网格
python mesh.py
```

### 3. 可视化结果

使用ParaView打开 `output/` 或 `output_ogrid/` 目录中的VTK文件。

## 输出文件

### 模拟结果（plane_2D.py）
- **VTK文件**：`output/acoustic_XXXX.vtk`
  - **包含字段**：
    - `valid_mask`：有效区域掩码（0=无效，1=有效）
    - `pressure`：压力场 [Pa]（无效区域为NaN）
    - `velocity`：速度向量 [m/s] (u, v, 0)（无效区域为0）
    - `velocity_magnitude`：速度大小 [m/s]（无效区域为NaN）
  - **统计信息**：每次输出时显示压力和速度的统计信息（最小值、最大值、平均值）

### 非结构化网格版本输出（plane_2D_Ogrid.py）
- **VTK文件**：`output_ogrid/acoustic_ogrid_XXXX.vtk`（基于时间间隔输出）
- **日志文件**：`output_ogrid/simulation_log.txt`
  - 时间步数和当前时间
  - 压力、速度残差
  - 压力统计（最小值、最大值、平均值）
  - 日志输出时间间隔由`log_time_interval`参数控制

### 网格文件
- **`mesh/o_cut_annulus.vtk`** - 环形网格
  - 生成时输出详细的网格统计和质量信息
  - 包含网格质量检查结果

## 项目结构

```
acoustic_RDE/
├── README.md                 # 本文件
├── README_INSTALL.md         # 安装说明
├── LICENSE                   # MIT许可证
├── requirements.txt          # Python依赖
├── .gitignore               # Git忽略文件
│
├── plane_2D.py              # 结构化网格模拟（主程序）
├── plane_2D_Ogrid.py        # 非结构化O网格模拟（主程序，高性能优化版本）
├── ogrid_preview_gui.py     # O网格初始化预览 GUI（先预览压力分布再决定是否运行）
├── control.py               # 参数控制模块（统一管理所有参数）
├── mesh.py                  # 网格生成
│
├── signal_acoustic_1D.py    # 1D可视化脚本
├── signal_acoustic_2D.py    # 2D可视化脚本
│
├── mesh/                    # 网格文件目录
│   └── o_cut_annulus.vtk
├── output/                   # 结构化网格版本输出
└── output_ogrid/            # 非结构化网格版本输出
```

## 技术特点

### 数值方法
- **时间积分**：四階Runge-Kutta方法（RK4），四阶精度
- **空间离散**：
  - 结构化网格：有限差分法（中心差分+边界单侧差分）
  - 非结构化网格：有限体积法（Green-Gauss方法）
- **边界处理**：
  - 硬壁边界条件，法向速度为零（u·n = 0）
  - 边界处使用单侧差分（前向/后向），避免周期性边界错误
  - 正确计算内壁和外壁的法向量方向

### 代码质量保证
- **物理正确性验证**：
  - 源项单位检查（确保为[Pa/s]）
  - CFL条件自动检查
  - 边界条件物理正确性
- **参数一致性**：所有文件的几何参数已统一
- **网格质量保证**：自动进行网格质量检查（面积、连接性）
- **数值稳定性**：CFL检查、数值滤波、边界处理

### 数值稳定性
- **CFL条件检查**：自动检查CFL数，如果超过限制（CFL_max=0.5）会给出警告和建议
- **数值滤波机制**：抑制高频振荡，可配置滤波强度（filter_strength=0.01）
- **边界处使用单侧差分**：避免周期性边界错误，确保边界处数值精度
- **运动黏度项**：明确为人工数值耗散，主要用于稳定性，实际物理耗散很小

### 性能优化（非结构化网格版本）
- **预计算几何量**：在网格生成时预计算所有边的向量、法向量、长度等，避免重复计算
- **预计算边-邻居映射**：建立边到邻居单元的映射表，避免运行时的查找操作
- **向量化操作**：使用numpy数组操作替代Python循环，大幅提升计算速度
- **直接计算拉普拉斯**：避免先计算梯度再计算散度的双重计算
- **向量化源项和滤波**：使用numpy向量化操作替代Python循环
- **内存优化**：预分配并重用RK4/滤波等工作数组，结合显式垃圾回收，长时间运行内存占用保持稳定
- **预期性能提升**：10-20倍（对于4000个网格，从2-3秒/步降至0.1-0.3秒/步）
- **适用规模**：对于小到中等规模网格（<50000单元），优化后的串行计算已经足够快

## 参数说明

**注意**：所有参数现在统一在 `control.py` 模块中管理。修改参数时，请编辑 `control.py` 文件中的 `control()` 函数。

### 几何参数
- `R = 0.01 m`：外半径
- `r_core = 0.002 m`：内半径（避免中心奇点）
- `dr = 0.0002 m`：径向网格间距
- `dtheta_base = 0.0002 m`：角度间距基准值（用于计算角度方向网格密度）

### 物理参数
- `ρ₀ = 1.225 kg/m³`：空气密度
- `c₀ = 343.0 m/s`：声速
- `ν = 1.5e-5 m²/s`：运动黏度（主要用于数值稳定性）

### 源项参数
- `wave_pressure = 10.0 Pa`：爆轰波压强幅度
- `v_rde = 1400.0 m/s`：爆轰波传播速度
- `detonation_width = 0.001 m`：爆轰波在径向上的宽度（从外壁向内量，爆轰波被压缩在外壁附近的一条窄带内）
- `sigma = 0.001 m`：周向方向的高斯衰减尺度
- `omega`：角速度（自动计算：`v_rde / R`）
- `tau`：特征时间（自动计算：`2πR / v_rde`）

### 时间参数
- `dt = 1e-9 s`：时间步长
- `t_end = 1e-3 s`：结束时间

### 数值计算参数
- `filter_strength = 0.01`：数值滤波强度（0-1）
- `apply_filter = True`：是否应用数值滤波
- `filter_frequency = 10`：滤波频率（每N步滤波一次）
- `CFL_max = 0.5`：最大CFL数（用于稳定性检查）
- `boundary_tolerance`：边界识别容差（自动计算：`1.5 * dr`）

### 输出参数
- `output_dir = "output_ogrid"`：输出目录
- `output_time_interval = 1e-5 s`：VTK输出时间间隔（每N秒输出一次VTK文件）
- `log_time_interval = 1e-6 s`：日志输出时间间隔（每N秒输出一次日志）
- `log_file = "simulation_log.txt"`：日志文件名（保存在output_dir中）
- `progress_bar_width = 50`：进度条宽度（字符数）

**注意**：输出控制已改为基于时间间隔，更加直观。日志文件记录每个时间步的残差、压力统计等关键信息，方便后续分析。

### 如何修改参数

1. **直接编辑 `control.py`**：
   ```python
   def control():
       # 修改这里的参数值
       R = 0.015  # 例如：增大外半径
       dr = 0.0001  # 例如：减小网格间距（更密的网格）
       # ...
   ```

2. **运行主程序**：
   ```bash
   python plane_2D_Ogrid.py
   ```
   主程序会自动从 `control()` 函数读取参数。

## 注意事项

1. **参数管理**：
   - `plane_2D_Ogrid.py`的参数统一在 `control.py` 中管理
   - `plane_2D.py`的参数直接在文件中定义，但已与`mesh.py`保持一致
   - 所有文件的几何参数（R, r_core, dr）已统一为R=0.01m, r_core=0.002m, dr=0.0002m

2. **网格一致性**：
   - `mesh.py`和`plane_2D.py`的几何参数已保持一致
   - `signal_acoustic_1D.py`和`signal_acoustic_2D.py`的半径参数已统一为R=0.01m

3. **CFL条件**：代码会自动检查CFL数，如果超过限制（CFL_max=0.5）会给出警告和建议的时间步长

4. **性能优化**：
   - `plane_2D_Ogrid.py`：已优化，不再使用multiprocessing，性能提升通过预计算和向量化实现
   - `plane_2D.py`：使用RK4方法，性能已优化（减少打印频率）

5. **输出文件**：
   - 输出文件可能很大，建议定期清理或使用`.gitignore`忽略
   - VTK文件包含完整的速度场和压力场数据，便于后续分析

6. **物理正确性**：
   - 源项单位已修正为[Pa/s]，使用特征时间进行转换
   - 运动黏度项明确为人工数值耗散
   - 边界条件符合物理（硬壁边界，法向速度为零）

7. **网格质量**：
   - `mesh.py`生成网格时会自动进行质量检查
   - 确保网格闭合性和边界完整性
   - 输出详细的网格统计信息

## 引用

如果使用本代码进行研究，请引用：

```
Qi Sun, RDE Acoustic Simulation Code, 2026
College of Mechanics and Engineering Science, Peking University
```

## 作者信息

**作者**：Qi Sun  
**邮箱**：ernest-llg@outlook.com  
**单位**：College of Mechanics and Engineering Science  
**机构**：Peking University  
**邮编**：100871

## 版权与许可

本项目采用 **MIT License** 开源许可证。

### 版权声明

Copyright (c) 2026 Qi Sun

### 许可证说明

MIT License 是一个宽松的开源许可证，允许：

- ✅ **商业使用**：可以用于商业项目
- ✅ **修改**：可以修改代码
- ✅ **分发**：可以分发代码
- ✅ **私人使用**：可以私人使用
- ✅ **专利使用**：可以使用专利

**唯一要求**：
- 保留版权声明和许可证声明

**不提供担保**：
- 软件按"原样"提供，不提供任何明示或暗示的担保

完整的许可证文本请参见 [LICENSE](LICENSE) 文件。

## 贡献

欢迎提交Issue和Pull Request来改进代码。

## 更新日志

### 2026-01-27（最新更新）

#### 物理正确性改进
- **源项单位修正**：修正源项单位从[Pa·rad/s]到[Pa/s]，使用特征时间tau=2πR/v_rde进行转换
- **运动黏度说明**：明确运动黏度项主要用于数值稳定性（人工耗散），实际物理耗散很小
- **边界条件改进**：实现正确的硬壁边界条件，确保法向速度为零

#### 参数一致性改进
- **半径参数统一**：所有文件的半径参数统一为R=0.01m
  - `plane_2D.py`: R=0.01m
  - `mesh.py`: R=0.01m
  - `signal_acoustic_1D.py`: R=0.01m（从0.005m更新）
  - `signal_acoustic_2D.py`: R=0.01m（从0.005m更新）
- **注释修正**：
  - `signal_acoustic_2D.py`：修正角度注释（10度，不是70度）
  - `signal_acoustic_2D.py`：明确压力单位为Pa（不是atm）

#### 网格质量改进（mesh.py）
- **网格闭合性**：修复theta数组不闭合问题，使用linspace确保闭合
- **边界完整性**：修复r数组可能超出边界的问题，确保最大值正好是R
- **质量检查**：添加单元面积检查、周期性边界连接验证
- **详细输出**：输出网格统计信息（面积、节点数、单元数、质量检查结果）

#### 输出改进（plane_2D.py）
- **完整数据输出**：
  - 添加速度场输出（velocity向量）
  - 添加速度大小输出（velocity_magnitude）
  - 添加有效区域掩码（valid_mask）
- **统计信息**：每次输出时显示压力和速度的统计信息
- **性能优化**：减少打印频率，提高计算效率

#### 数值方法改进
- **RK4方法**：使用四阶Runge-Kutta方法，提高精度和稳定性
- **边界差分**：边界处使用单侧差分，避免周期性边界错误
- **CFL检查**：自动检查并警告CFL条件违反

### 2026-01-27（早期版本）
- 初始版本发布
- 实现结构化网格和非结构化O网格两种版本
- 添加并行计算支持
- 完善边界条件和数值方法
- 添加完整的文档和安装说明
- **新增**：参数控制模块 `control.py`，统一管理所有模拟参数
- **重构**：`plane_2D_Ogrid.py` 从 `control.py` 读取参数，提高可维护性
- **新增**：基于时间间隔的输出控制（替代基于步数的输出）
- **新增**：百分比进度条显示，实时显示计算进度和预计剩余时间
- **新增**：计算日志文件，自动记录时间步、残差、压力统计等关键参数
- **改进**：函数拆分，提高代码可读性和可维护性
- **重大性能优化**：
  - 移除multiprocessing并行计算（对小规模网格开销过大）
  - 预计算几何量（边向量、法向量、长度等），避免重复计算
  - 预计算边-邻居映射，避免运行时查找（性能提升2-3倍）
  - 向量化所有关键操作（源项、滤波等），使用numpy数组操作
  - 直接计算拉普拉斯，避免双重计算（性能提升1.5倍）
  - **总体性能提升：10-20倍**（4000网格：从2-3秒/步降至0.1-0.3秒/步）

## 联系方式

如有问题或建议，请通过以下方式联系：

- **邮箱**：ernest-llg@outlook.com
- **单位**：北京大学 工学院 力学与工程科学系

---

**注意**：本代码库用于学术研究目的，使用前请仔细阅读LICENSE文件。
